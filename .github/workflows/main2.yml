name: Toffee Cookie Auto Update

on:
  schedule:

    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Requests
        run: pip install requests

      - name: Execute Update
        run: |
          python3 - << 'EOF'
          import requests, json, datetime, os, sys

          API_URL = "https://apis.allinonedev.top/tf/"
          SRC_JSON = "api.json"

          try:
              # Requesting the API
              r = requests.get(API_URL, timeout=15)
              ck = r.json().get("set_cookie", "")
              
              if not ck:
                  print("No cookie received")
                  sys.exit(0)

              if not os.path.exists(SRC_JSON):
                  # If api.json doesn't exist, try to create an empty list or exit
                  print("api.json missing, creating empty list")
                  channels = [] 
                  # sys.exit(0) # Commented out to prevent stop if file missing
              else:
                  with open(SRC_JSON, "r", encoding="utf-8") as f:
                      channels = json.load(f)

              ns_json = []
              ott_playlist = "#EXTM3U\n"
              updated = datetime.datetime.now().strftime("%d-%m-%Y %I:%M:%S %p")

              tengo = {
                  "name": "Toffee App All Channel Link with Headers",
                  "owner": "Bd Coder Boy\nTelegram: https://t.me/codecrafterceo",
                  "channels_amount": 0,
                  "updated_on": updated,
                  "channels": []
              }

              for ch in channels:
                  link = ch.get("link")
                  if not link:
                      continue

                  name = ch.get("name", "Live")
                  logo = ch.get("logo", "")
                  cat  = ch.get("category_name", "Bangladeshi")
                  
                  # Host parsing safety
                  try:
                      host = link.split("//")[-1].split("/")[0]
                  except:
                      host = ""

                  ns_json.append({
                      "name": name,
                      "logo": logo,
                      "link": link,
                      "cookie": ck
                  })

                  tengo["channels"].append({
                      "category_name": cat,
                      "name": name,
                      "link": link,
                      "logo": logo,
                      "headers": {
                          "Host": host,
                          "Cookie": ck,
                          "User-Agent": "Toffee (Linux;Android 14)",
                          "Accept-Encoding": "gzip"
                      }
                  })

                  ott_playlist += f'''#EXTINF:-1 group-title="{cat}" tvg-logo="{logo}", {name}
          #EXTVLCOPT:http-user-agent=Toffee (Linux;Android 14)
          #EXTVLCOPT:http-cookie={ck}
          {link}
          '''

              tengo["channels_amount"] = len(ns_json)

              with open("ns.m3u", "w", encoding="utf-8") as f:
                  json.dump(ns_json, f, indent=2)

              with open("channels.json", "w", encoding="utf-8") as f:
                  json.dump(ns_json, f, indent=2)

              with open("ott.m3u", "w", encoding="utf-8") as f:
                  f.write(ott_playlist)

              with open("tengo.json", "w", encoding="utf-8") as f:
                  json.dump(tengo, f, indent=2)

              print("Update completed successfully")

          except Exception as e:
              print("ERROR:", e)
              sys.exit(1) # Fail the workflow on error
          EOF

      - name: Push Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          git diff-index --quiet HEAD || (git commit -m "Auto update $(date)" && git push origin main)
